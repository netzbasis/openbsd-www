<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<title>
SMTPD.CONF(5)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
SMTPD.CONF(5)</td>
<td class="head-vol" align="center">
OpenBSD Programmer's Manual</td>
<td class="head-rtitle" align="right">
SMTPD.CONF(5)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">smtpd.conf</b> &#8212; <span class="desc">Simple Mail Transfer Protocol daemon configuration file</span></div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> <b class="name">smtpd.conf</b> is the configuration file for the mail daemon <a class="link-man">smtpd(8)</a>.<p>
The current line can be extended over multiple lines using a backslash (&#8216;&#92;&#8217;). Comments can be put anywhere in the file using a hash mark (&#8216;#&#8217;), and extend to the end of the current line. Care should be taken when commenting out multi-line text: the comment is effective until the end of the entire block.<p>
Argument names not beginning with a letter, digit, or underscore must be quoted. Arguments containing whitespace should be surrounded by double quotes (").<p>
Macros can be defined that will later be expanded in context. Macro names must start with a letter, digit, or underscore, and may contain any of those characters. Macro names may not be reserved words (for example <i class="arg">listen</i>, <i class="arg">accept</i>, <i class="arg">port</i>). Macros are not expanded inside quotes.<p>
For example:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
lan_addr = "192.168.0.1" 
listen on $lan_addr 
listen on $lan_addr tls auth</pre>
<p>
Additional configuration files can be included with the <b class="cmd">include</b> keyword, for example:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
include "/etc/mail/smtpd.conf.local"</pre>
<p>
The syntax of <b class="name">smtpd.conf</b> is described below.<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">accept</b> | <b class="cmd">reject</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
<a class="link-man">smtpd(8)</a> accepts and rejects messages based on information gathered during the SMTP session.<p>
For each message processed by the daemon, the filter rules are evaluated in sequential order, from first to last. The first matching rule decides what action is taken. If no rule matches the message, the default action is to reject the message. An exclamation mark may be specified to perform a reverse match.<p>
Following the accept/reject decision comes the optional tag matching:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">tagged</b> &#91;<span class="opt"><b class="cmd">!</b></span>&#93; <b class="cmd">tag</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
If specified, the rule will only be matched if the client session was tagged with <i class="arg">tag</i>.</dd>
</dl>
<p>
After that the client's IP address filter is specified:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">from any</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Make the rule match regardless of the IP of connecting client.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">from</b> &#91;<span class="opt"><b class="cmd">!</b></span>&#93; <b class="cmd">local</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
The rule matches only locally originating connections. This is the default, and may be omitted.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">from</b> &#91;<span class="opt"><b class="cmd">!</b></span>&#93; <b class="cmd">source</b> <b class="cmd">table</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
The rule matches if the connection is made from a client whose address is declared in the table <i class="arg">table</i>.</dd>
</dl>
<p>
In addition, finer filtering may be achieved on the sender if desired:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">sender</b> &#91;<span class="opt"><b class="cmd">!</b></span>&#93; <b class="cmd">senders</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
If specified, the rule will only be matched if the sender email address is found in the table <i class="arg">senders</i>. The table may contain complete email addresses or apply to an entire domain if prefixed with @.</dd>
</dl>
<p>
Next comes the selection based on the domain the message is sent to:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">for any</b> &#91;<span class="opt"><b class="cmd">alias</b> &#60;<i class="arg">aliases</i>&#62;</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Make the rule match regardless of the domain it is sent to. If specified, the table <i class="arg">aliases</i> is used for looking up alternative destinations for all addresses.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">for any virtual</b> &#60;<i class="arg">vmap</i>&#62;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Make the rule match regardless of the domain it is sent to. The <i class="arg">vmap</i> table will be used as the virtual domain mapping.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">for</b> &#91;<span class="opt"><b class="cmd">!</b></span>&#93; <b class="cmd">domain</b> <i class="arg">domain</i> &#91;<span class="opt"><b class="cmd">alias</b> &#60;<i class="arg">aliases</i>&#62;</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
This rule applies to mail destined for the specified <i class="arg">domain</i>. This parameter supports the &#8216;*&#8217; wildcard, so that a single rule for all sub-domains can be used, for example:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
accept for domain "*.example.com" deliver to mbox</pre>
<p>
If specified, the table <i class="arg">aliases</i> is used for looking up alternative destinations for addresses in this <i class="arg">domain</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">for</b> &#91;<span class="opt"><b class="cmd">!</b></span>&#93; <b class="cmd">domain</b> &#60;<i class="arg">domains</i>&#62; &#91;<span class="opt"><b class="cmd">alias</b> &#60;<i class="arg">aliases</i>&#62;</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
This rule applies to mail destined to domains which are part of the table <i class="arg">domains</i>.<p>
If specified, the table <i class="arg">aliases</i> is used for looking up alternative destinations for addresses in these <i class="arg">domains</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">for</b> &#91;<span class="opt"><b class="cmd">!</b></span>&#93; <b class="cmd">domain</b> <i class="arg">domain</i> <b class="cmd">virtual</b> &#60;<i class="arg">users</i>&#62;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
This rule applies to mail destined for the specified virtual <i class="arg">domain</i>. This parameter supports the &#8216;*&#8217; wildcard, so that a single rule for all sub-domains can be used, for example:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
accept for domain "*.example.com" &#92; 
       virtual &lt;users&gt; deliver to mbox</pre>
<p>
The table <i class="arg">users</i> holds a key-value mapping of virtual to system users. For an example of how to configure the <i class="arg">users</i> table, see <a class="link-man">makemap(8)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">for</b> &#91;<span class="opt"><b class="cmd">!</b></span>&#93; <b class="cmd">domain</b> &#60;<i class="arg">domains</i>&#62; <b class="cmd">virtual</b> &#60;<i class="arg">users</i>&#62;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
This rule applies to mail destined for the virtual domains specified in the table <i class="arg">domains</i>.<p>
The table <i class="arg">users</i> holds a key-value mapping of virtual to system users. For an example of how to configure the <i class="arg">users</i> table, see <a class="link-man">makemap(8)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">for</b> &#91;<span class="opt"><b class="cmd">!</b></span>&#93; <b class="cmd">local</b> &#91;<span class="opt"><b class="cmd">alias</b> &#60;<i class="arg">aliases</i>&#62;</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
This rule applies to mail destined to &#8220;localhost&#8221; and to the default server name. See the <i class="link-sec"><a class="link-sec" href="#x46494c4553">FILES</a></i> entry for <i class="file">/etc/mail/mailname</i> below for details of how the server name is determined.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">for</b> &#91;<span class="opt"><b class="cmd">!</b></span>&#93; <b class="cmd">local</b> <b class="cmd">virtual</b> &#60;<i class="arg">vmap</i>&#62;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
This rule applies to mail destined to &#8220;localhost&#8221; and to the default server name. The <i class="arg">vmap</i> table will be used as the virtual domain mapping.</dd>
</dl>
<p>
Further filtering may be achieved on specific recipients if desired:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">recipient</b> &#91;<span class="opt"><b class="cmd">!</b></span>&#93; <i class="arg">recipients</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
If specified, the rule will only be matched if the recipient email address is found in the table <i class="arg">recipients</i>. The table may contain complete email addresses or apply to an entire domain if prefixed with &#8216;@&#8217;.</dd>
</dl>
<p>
If the method of delivery is local, a user database may be specified to override the system database:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
&#91;<span class="opt"><b class="cmd">userbase</b> &#60;<i class="arg">table</i>&#62;</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Look up users in the table <i class="arg">table</i> instead of performing system lookups using the <a class="link-man">getpwnam(3)</a> function.</dd>
</dl>
<p>
Finally, the method of delivery is specified:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">deliver to lmtp</b> &#91;<span class="opt"><i class="arg">host</i>:<i class="arg">port</i> | <i class="arg">socket</i></span>&#93;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Mail is delivered to <i class="arg">host</i>:<i class="arg">port</i>, or to the <span class="unix">UNIX</span> <i class="arg">socket</i> over LMTP.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">deliver to maildir</b> <i class="arg">path</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Mail is added to a maildir. Its location, <i class="arg">path</i>, may contain format specifiers that are expanded before use (see above). If <i class="arg">path</i> is not provided, then <i class="file">~/Maildir</i> is assumed.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">deliver to mbox</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Mail is delivered to the local user's system mailbox in <i class="file">/var/mail</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">deliver to mda</b> <i class="arg">program</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Mail is piped to the specified <i class="arg">program</i>, which is run with the privileges of the user the message is destined to. This parameter may use conversion specifiers that are expanded before use (see above).</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">relay</b> &#91;<span class="opt"><b class="cmd">backup</b> &#91;<span class="opt"><i class="arg">mx</i></span>&#93;</span>&#93; &#91;<span class="opt"><b class="cmd">as</b> <i class="arg">address</i></span>&#93; &#91;<span class="opt"><b class="cmd">source</b> <i class="arg">source</i></span>&#93; &#91;<span class="opt"><b class="cmd">hostname</b>&#160;<i class="arg">name</i></span>&#93; &#91;<span class="opt"><b class="cmd">hostnames</b>&#160;<i class="arg">names</i></span>&#93; &#91;<span class="opt"><b class="cmd">pki</b> <i class="arg">pkiname</i></span>&#93; &#91;<span class="opt"><b class="cmd">tls</b> | <b class="cmd">verify</b></span>&#93;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Mail is relayed. The routing decision is based on the DNS system.<p>
If the <b class="cmd">backup</b> parameter is specified, the current server will act as a backup server for the target domain. Accepted mails are only relayed through servers with a lower preference value in the MX record for the domain than the one specified in <i class="arg">mx</i>. If <i class="arg">mx</i> is not specified, the default server name will be assumed.<p>
If the <b class="cmd">as</b> parameter is specified, <a class="link-man">smtpd(8)</a> will rewrite the sender advertised in the SMTP session. <i class="arg">address</i> may be a user, a domain prefixed with &#8216;@&#8217;, or an email address, causing smtpd to rewrite the user-part, the domain-part, or the entire address, respectively.<p>
If the <b class="cmd">source</b> parameter is specified, <a class="link-man">smtpd(8)</a> will explicitly bind to an address found in the table referenced by <i class="arg">source</i> when connecting to the relay. If the table contains more than one address, they are picked in turn each time a new connection is opened.<p>
By default, when connecting to a remote server, <a class="link-man">smtpd(8)</a> advertises its default server name. A <b class="cmd">hostname</b> parameter may be specified to advertise the alternate hostname <i class="arg">name</i>. If the <b class="cmd">source</b> parameter is used, the <b class="cmd">hostnames</b> parameter may be specified to advertise a hostname based on the source address. Table <i class="arg">names</i> contains a mapping of IP addresses to hostnames and <a class="link-man">smtpd(8)</a> will automatically select the name that matches its source address when connected to the remote server. The <b class="cmd">hostname</b> and <b class="cmd">hostnames</b> parameters are mutually exclusive.<p>
When relaying, STARTTLS is always attempted if available on remote host and OpenSMTPD will try to present a certificate matching the outgoing hostname if one is registered in the pki. If <b class="cmd">pki</b> is specified, the certificate registered for <i class="arg">pkiname</i> is used instead.<p>
If <b class="cmd">tls</b> is specified, OpenSMTPD will refuse to relay unless the remote host provides STARTTLS.<p>
If <b class="cmd">verify</b> is specified, OpenSMTPD will refuse to relay unless the remote host provides STARTTLS and the certificate it presented has been verified.<p>
Note that the <b class="cmd">tls</b> and <b class="cmd">verify</b> options are mutually exclusive and should only be used in private networks as they will prevent proper relaying on the Internet.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">relay via</b> <i class="arg">host</i> &#91;<span class="opt"><b class="cmd">auth</b> &#60;<i class="arg">auth</i>&#62;</span>&#93; &#91;<span class="opt"><b class="cmd">as</b> <i class="arg">address</i></span>&#93; &#91;<span class="opt"><b class="cmd">source</b> <i class="arg">source</i></span>&#93; &#91;<span class="opt"><b class="cmd">hostname</b> <i class="arg">name</i></span>&#93; &#91;<span class="opt"><b class="cmd">hostnames</b> <i class="arg">names</i></span>&#93; &#91;<span class="opt"><b class="cmd">pki</b> <i class="arg">pkiname</i></span>&#93; &#91;<span class="opt"><b class="cmd">verify</b></span>&#93;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Mail is relayed through the specified <i class="arg">host</i> expressed as a URL. For example:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
smtp://mx1.example.org		# use SMTP 
smtp://mx1.example.org:4321	# use SMTP &#92; 
				# with port 4321 
lmtp://localhost:2026		# use LMTP &#92; 
				# with port 2026</pre>
<p>
The communication channel may be secured using one of the secure schemas. For example:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
tls://mx1.example.org		# use TLS 
smtps://mx1.example.org		# use SMTPS 
secure://mx1.example.org	# try SMTPS and &#92; 
				# fallback to TLS</pre>
<p>
In addition, credentials for authenticated relaying may be provided when using a secure schema. For example:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
tls+auth://label@mx.example.org		# over TLS 
smtps+auth://label@mx.example.org	# over SMTPS 
secure+auth://label@mx.example.org	# over either &#92; 
					# SMTPS or TLS</pre>
<p>
If a pki entry exists for the outgoing hostname, or one is provided with <i class="arg">pkiname</i>, the associated certificate will be sent to the remote server.<p>
If an SMTPAUTH session with <i class="arg">host</i> is desired, the <b class="cmd">auth</b> parameter is used to specify the <i class="arg">auth</i> table that holds the credentials. Credentials will be looked up using the label provided in the URL.<p>
If the <b class="cmd">as</b> parameter is specified, <a class="link-man">smtpd(8)</a> will rewrite the sender advertised in the SMTP session. <i class="arg">address</i> may be a user, a domain prefixed with &#8216;@&#8217;, or an email address, causing smtpd to rewrite the user-part, the domain-part, or the entire address, respectively.<p>
If the <b class="cmd">source</b> parameter is specified, <a class="link-man">smtpd(8)</a> will explicitly bind to an address found in the table referenced by <i class="arg">table</i> when connecting to the relay. If the table contains more than one address, they are picked in turn each time a new connection is opened.<p>
By default, when connecting to a remote server, <a class="link-man">smtpd(8)</a> advertises its default server name. A <b class="cmd">hostname</b> parameter may be specified to advertise the alternate hostname <i class="arg">name</i>. If the <b class="cmd">source</b> parameter is used, the <b class="cmd">hostnames</b> parameter may be specified to advertise a hostname based on the source address. Table <i class="arg">names</i> contains a mapping of IP addresses to hostnames and <a class="link-man">smtpd(8)</a> will automatically select the name that matches its source address when connected to the remote server. The <b class="cmd">hostname</b> and <b class="cmd">hostnames</b> parameters are mutually exclusive.</dd>
</dl>
<p>
If <b class="cmd">verify</b> is specified, OpenSMTPD will refuse to relay unless the remote host provides STARTTLS and the certificate it presented has been verified. The relay URL must specify TLS for this option to be valid.<p>
Additional per-rule adjustments available:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">expire</b> <i class="arg">n</i> &#123;<i class="arg">s|m|h|d</i>&#125;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Specify how long a message that matched this rule can stay in the queue.</dd>
</dl>
</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">bounce-warn</b> <i class="arg">n</i> &#123;<i class="arg">s|m|h|d</i>&#125; &#91;, <i class="arg">...</i>&#93;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Specify the delays for which temporary failure reports must be generated when messages are stuck in the queue. For example:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
bounce-warn	1h, 6h, 2d</pre>
<p>
will generate a failure report when an envelope is in the queue for more than one hour, six hours and two days. The default is 4h.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">expire</b> <i class="arg">n</i> &#123;<i class="arg">s|m|h|d</i>&#125;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Specify how long a message can stay in the queue. The default value is 4 days. For example:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
expire 4d	# expire after 4 days 
expire 10h	# expire after 10 hours</pre>
</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">limit mta</b> &#91;<span class="opt"><b class="cmd">for</b> <b class="cmd">domain</b> <i class="arg">domain</i></span>&#93; <i class="arg">family</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Instruct <a class="link-man">smtpd(8)</a> to only use the specified address <i class="arg">family</i> for outgoing connections. Accepted values are <b class="cmd">inet4</b> and <b class="cmd">inet6</b>. If a <i class="arg">domain</i> is specified, the restriction only applies when connecting to MXs for this domain.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">limit scheduler max-inflight</b> <i class="arg">num</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Suspend the scheduling of envelopes for deliver/relay until the number of inflight envelopes falls below <i class="arg">num</i>. Changing the default value might degrade performances.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">listen on</b>&#160;<i class="arg">interface</i> &#91;<span class="opt"><i class="arg">family</i></span>&#93; &#91;<span class="opt"><b class="cmd">port</b>&#160;<i class="arg">port</i></span>&#93; &#91;<span class="opt"><b class="cmd">tls</b>&#160;|&#160;<b class="cmd">tls-require</b>&#160;|&#160;<b class="cmd">tls-require&#160;verify</b>&#160;|&#160;<b class="cmd">smtps</b>&#160;|&#160;<b class="cmd">secure</b></span>&#93; &#91;<span class="opt"><b class="cmd">pki</b>&#160;<i class="arg">pkiname</i></span>&#93; &#91;<span class="opt"><b class="cmd">auth</b>&#160;|&#160;<b class="cmd">auth-optional</b>&#160;|&#160;<b class="cmd">auth</b>&#160;<i class="arg">authtable</i>&#160;|&#160;<b class="cmd">auth-optional</b>&#160;<i class="arg">authtable</i></span>&#93; &#91;<span class="opt"><b class="cmd">tag</b>&#160;<i class="arg">tag</i></span>&#93; &#91;<span class="opt"><b class="cmd">hostname</b>&#160;<i class="arg">hostname</i></span>&#93; &#91;<span class="opt"><b class="cmd">hostnames</b>&#160;<i class="arg">names</i></span>&#93; &#91;<span class="opt"><b class="cmd">mask-source</b></span>&#93;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Specify an <i class="arg">interface</i> and <i class="arg">port</i> to listen on. An interface group, an IP address or a domain name may be used in place of <i class="arg">interface</i>. The <i class="arg">family</i> parameter can be used to listen only on specific address family. Accepted values are <b class="cmd">inet4</b> and <b class="cmd">inet6</b>.<p>
Secured connections are provided either using STARTTLS (<b class="cmd">tls</b>), by default on port 25, or SMTPS (<b class="cmd">smtps</b>), by default on port 465. <b class="cmd">tls-require</b> may be used to force clients to establish a secure connection before being allowed to start an SMTP transaction.<p>
If <b class="cmd">tls-require verify</b> is specified, the client must provide a valid certificate to be able to establish an SMTP session.<p>
<b class="cmd">secure</b> may be specified to provide both STARTTLS and SMTPS services. Host certificates may be used for these connections, and must be priorly declared using the pki directive. If <b class="cmd">pki</b> is specified, a certificate matching <b class="cmd">name</b> is searched for.<p>
If the <b class="cmd">auth</b> parameter is used, then a client may only start an SMTP transaction after a successful authentication. Any remote sender that passed SMTPAUTH is treated as if it was the server's local user that was sending the mail. This means that filter rules using "from local" will be matched. If <b class="cmd">auth-optional</b> is specified, then SMTPAUTH is not required to establish an SMTP transaction. This is only useful to let a listener accept incoming mail from untrusted senders and outgoing mail from authenticated users in situations where it is not possible to listen on the submission port.<p>
Both <b class="cmd">auth</b> and <b class="cmd">auth-optional</b> accept a table as parameter. When provided, credentials are looked up in this table. Credentials format is described in <a class="link-man">table(5)</a>.<p>
If the <b class="cmd">tag</b> parameter is used, then clients connecting to the listener will be tagged <i class="arg">tag</i>.<p>
If the <b class="cmd">hostname</b> parameter is used, then it will be used in the greeting banner instead of the default server name.<p>
The <b class="cmd">hostnames</b> parameter overrides the server name for specific addresses. Table <i class="arg">names</i> contains a mapping of IP addresses to hostnames and <a class="link-man">smtpd(8)</a> will use the hostname that matches the address on which the connection arrives if it is found in the mapping.<p>
If the <b class="cmd">mask-source</b> parameter is used, then the listener will skip the "from" part when prepending the "Received" header.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">max-message-size</b> <i class="arg">n</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Specify a maximum message size of <i class="arg">n</i> bytes. The argument may contain a multiplier, as documented in <a class="link-man">scan_scaled(3)</a>. The default maximum message size is 35MB if none is specified.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">pki</b> <i class="arg">hostname</i> <b class="cmd">certificate</b> <i class="arg">certfile</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Associate the certificate located in <i class="arg">certfile</i> with <i class="arg">hostname</i>.<p>
A certificate chain may be created by appending one or many certificates, including a Certificate Authority certificate, to <i class="arg">certfile</i>.<p>
Creation of certificates is documented in <a class="link-man">starttls(8)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">pki</b> <i class="arg">hostname</i> <b class="cmd">key</b> <i class="arg">keyfile</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Associate the key located in <i class="arg">keyfile</i> with <i class="arg">hostname</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">pki</b> <i class="arg">hostname</i> <b class="cmd">ca</b> <i class="arg">cafile</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Associate a custom CA certificate <i class="arg">cafile</i> with <i class="arg">hostname</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">pki</b> <i class="arg">hostname</i> <b class="cmd">dhparams</b> <i class="arg">dhfile</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Associate the Diffie-Hellman parameters located in <i class="arg">dhfile</i> with <i class="arg">hostname</i>.<p>
The parameters are used for ephemeral key exchange. If not specified, OpenSMTPD will use safely generated builtin parameters.<p>
Creation of Diffie-Hellman parameters is documented in <a class="link-man">openssl(1)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">queue compression</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Enable transparent compression of envelopes and messages. The only supported algorithm at the moment is gzip. Envelopes and messages may be inspected using the <a class="link-man">smtpctl(8)</a> or <a class="link-man">gzcat(1)</a> utilities.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">queue encryption</b> &#91;<span class="opt">key <i class="arg">key</i></span>&#93;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Enable transparent encryption of envelopes and messages. <i class="arg">key</i> must be a 16-byte random key in hexadecimal representation. It can be obtained using the <a class="link-man">openssl(1)</a> utility as follow:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
$ openssl rand -hex 16</pre>
<p>
If the <i class="arg">key</i> parameter is not specified, it is read with <a class="link-man">getpass(3)</a> at startup. If <i class="arg">key</i> is "stdin", then it is read from the standard input at startup.<p>
The only supported algorithm is AES-256 in GCM mode. Envelopes and messages may be inspected using the <a class="link-man">smtpctl(8)</a> utility.<p>
Queue encryption can be used with queue compression and will always perform compression before encryption.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">table</b> <i class="arg">name</i> &#91;<span class="opt"><i class="arg">type</i>:</span>&#93;<i class="arg">config</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Tables are used to provide additional configuration information for <a class="link-man">smtpd(8)</a> in the form of lists or key-value mappings. The format of the entries depends on what the table is used for. Refer to <a class="link-man">table(5)</a> for the exhaustive documentation.<p>
The table is identified using table name <i class="arg">name</i>; the name itself is arbitrarily chosen.<p>
<i class="arg">type</i> specifies the table backend, and should be one of the following:<p>
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
db</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Information is stored in a file created using <a class="link-man">makemap(8)</a>.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
file</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Information is stored in a plain text file using the same format as used to generate <a class="link-man">makemap(8)</a> mappings. This is the default.</dd>
</dl>
<p>
<i class="arg">config</i> specifies a configuration file for the table data. It must be an absolute path to a file for the &#8220;file&#8221; and &#8220;db&#8221; table types.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">table</b> <i class="arg">name</i> &#123;<i class="arg">value</i> &#91;<span class="opt">, <i class="arg">...</i></span>&#93;&#125;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Tables containing list of static values may be declared using an inlined notation.<p>
The table is identified using table name <i class="arg">name</i>; the name itself is arbitrarily chosen.<p>
The table must contain at least one value and may declare many values as a list of comma separated strings.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">table</b> <i class="arg">name</i> &#123;<i class="arg">key</i>=<i class="arg">value</i> &#91;<span class="opt">, <i class="arg">...</i></span>&#93;&#125;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Tables containing static key-value mappings may be declared using an inlined notation.<p>
The table is identified using table name <i class="arg">name</i>; the name itself is arbitrarily chosen.<p>
The table must contain at least one key-value mapping and may declare many mappings as a list of comma separated <i class="arg">key</i>=<i class="arg">value</i> descriptions.</dd>
</dl>
<p>
Some configuration directives support expansion of their parameters at runtime. Such directives (for example <i class="arg">deliver to maildir</i>, <i class="arg">deliver to mda</i>) may use format specifiers which will be expanded before delivery or relaying. The following formats are currently supported:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
%{sender}	     sender email address 
%{sender.user}	     user part of the sender email address 
%{sender.domain}     domain part of the sender email address 
%{rcpt}              recipient email address 
%{rcpt.user}	     user part of the recipient email address 
%{rcpt.domain}	     domain part of the recipient email address 
%{dest}              recipient email address after expansion 
%{dest.user}	     user part after expansion 
%{dest.domain}	     domain part after expansion 
%{user.username}     local user 
%{user.directory}    home directory of the local user</pre>
<p>
Expansion formats also support partial expansion using the optional bracket notations with substring offset. For example, with recipient domain "example.org":<p>
<pre style="margin-left: 5.00ex;" class="lit display">
%{rcpt.domain[0]}	expands to "e" 
%{rcpt.domain[1]}	expands to "x" 
%{rcpt.domain[8:]}	expands to "org" 
%{rcpt.domain[-3:]}	expands to "org" 
%{rcpt.domain[0:6]}	expands to "example" 
%{rcpt.domain[0:-4]}	expands to "example"</pre>
<p>
In addition, modifiers may be applied to the token. For example, with recipient "User+Tag@Example.org":<p>
<pre style="margin-left: 5.00ex;" class="lit display">
%{rcpt:lowercase}	expands to "user+tag@example.org" 
%{rcpt:uppercase}	expands to "USER+TAG@EXAMPLE.ORG" 
%{rcpt:strip}		expands to "User@Example.org" 
%{rcpt:lowercase|strip}	expands to "user@example.org"</pre>
<p>
For security concerns, expanded values are sanitized and potentially dangerous characters are replaced with ":". In situations where they are desirable, the "raw" modifier may be applied. For example, with recipient "user+t?g@example.org":<p>
<pre style="margin-left: 5.00ex;" class="lit display">
%{rcpt}		expands to "user+t:g@example.org" 
%{rcpt:raw}	expands to "user+t?g@example.org"</pre>
</div>
<div class="section">
<h1 id="x46494c4553">FILES</h1><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="file">/etc/mail/smtpd.conf</i></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
Default <a class="link-man">smtpd(8)</a> configuration file.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="file">/etc/mail/mailname</i></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
If this file exists, the first line is used as the server name. Otherwise, the server name is derived from the local hostname returned by <a class="link-man">gethostname(3)</a>, either directly if it is a fully qualified domain name, or by retreiving the associated canonical name through <a class="link-man">getaddrinfo(3)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="file">/var/spool/smtpd/</i></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
Spool directories for mail during processing.</dd>
</dl>
</div>
<div class="section">
<h1 id="x4558414d504c4553">EXAMPLES</h1> The default <b class="name">smtpd.conf</b> file which ships with <span class="unix">OpenBSD</span> listens on the loopback network interface (lo0), and allows for mail from users and daemons on the local machine, as well as permitting email to remote servers. Some more complex configurations are given below.<p>
This first example is the same as the default configuration, but all outgoing mail is forwarded to a remote SMTP server. A secrets file is needed to specify a username and password:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
# touch /etc/mail/secrets 
# chmod 640 /etc/mail/secrets 
# chown root:_smtpd /etc/mail/secrets 
# echo "label username:password" &gt; /etc/mail/secrets 
# makemap /etc/mail/secrets</pre>
<p>
<b class="name">smtpd.conf</b> would look like this:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
listen on lo0 
table aliases db:/etc/mail/aliases.db 
table secrets db:/etc/mail/secrets.db 
accept for local alias &lt;aliases&gt; deliver to mbox 
accept for any relay via tls+auth://label@smtp.example.com &#92; 
	auth &lt;secrets&gt;</pre>
<p>
In this second example, the aim is to permit mail relaying for any user that can authenticate using their normal login credentials. An RSA certificate must be provided to prove the server's identity. The mail server listens on all interfaces the default route(s) point to. Mail with a local destination should be sent to an external mda. First, the RSA certificate is created:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
# openssl genrsa -out /etc/ssl/private/mail.example.com.key 4096 
# openssl req -new -x509 -key /etc/ssl/private/mail.example.com.key &#92; 
	-out /etc/ssl/mail.example.com.crt -days 365 
# chmod 600 /etc/ssl/mail.example.com.crt 
# chmod 600 /etc/ssl/private/mail.example.com.key</pre>
<p>
In the example above, a certificate valid for one year was created. The configuration file would look like this:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
pki mail.example.com certificate "/etc/ssl/mail.example.com.crt" 
pki mail.example.com key "/etc/ssl/private/mail.example.com.key" 
 
listen on lo0 
listen on egress tls pki mail.example.com auth 
 
table aliases db:/etc/mail/aliases.db 
 
accept for local alias &lt;aliases&gt; deliver to mda "/path/to/mda -f -" 
accept from any for domain example.org &#92; 
	deliver to mda "/path/to/mda -f -" 
accept for any relay</pre>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man">mailer.conf(5)</a>, <a class="link-man">table(5)</a>, <a class="link-man">makemap(8)</a>, <a class="link-man">smtpd(8)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> <a class="link-man">smtpd(8)</a> first appeared in <span class="unix">OpenBSD&#160;4.6</span>.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
December 5, 2013</td>
<td class="foot-os" align="right">
OpenBSD 5.4</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

