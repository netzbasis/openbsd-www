<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Following -current and using snapshots</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="copyright" content="This document copyright 2005-2017 by OpenBSD">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="../openbsd.css">
<link rel="canonical" href="https://www.openbsd.org/faq/current.html">
</head>

<body bgcolor= "#ffffff" text= "#000000">

<h2>
<a href="../index.html">
<font color="#0000ff"><i>Open</i></font><font color="#000084">BSD</font></a>
<font color="#e00000">Following -current and using snapshots</font>
<small>
<a href="index.html" style="font-weight:normal; float:right">[FAQ Index]</a>
</small>
</h2>
<hr>
<p>

Active OpenBSD development is known as the
<a href="faq5.html#Flavors">-current</a> branch.
These sources are frequently compiled into releases known as <i>snapshots</i>.

<p>
Aggressive changes are sometimes pushed in this branch, and complications can
arise when building the latest code or upgrading from a previous point in time.
Some of the steps for getting over these hurdles are explained on this page.
Make sure you've read and understand how to
<a href="faq5.html">build the system from source</a> before using -current
and the instructions below.

<p>
In general, it's far easier to use snapshots, as developers will have gone
through much of the trouble for you already.

<p>
You should <b>always</b> use a snapshot as the starting point for running
-current.
This process typically consists of downloading (and verifying) the appropriate
<a href="faq4.html#bsd.rd">bsd.rd</a> file from the <tt>/snapshots/</tt>
directory of your preferred <a href="../ftp.html">mirror</a>, booting from it,
and choosing <tt>(U)pgrade</tt> at the prompt.
Any installed packages should then be
<a href="faq15.html#PkgUpdate">upgraded</a> after booting into the new system.

<p>
Upgrading to -current by compiling your own source code is not supported.

<p>
Most of these changes will have to be performed as root.


<h3 id="r20180411">2018/04/11 - meaning of listen on * port 80 changed
in httpd(8)</h3>

The meaning of <tt>listen on * port 80</tt> changed from "listen on
all IPv4 addresses" to "listen on all IPv4 <b>and</b> all IPv6 addresses".
If <tt>listen on * port 80</tt> is present, <tt>listen on :: port 80</tt>
needs to be removed.
For example,

<blockquote><pre>
listen on * port 80
listen on :: port 80
</pre></blockquote>

must be changed to:

<blockquote><pre>
listen on * port 80
</pre></blockquote>


<h3 id="r20180420">2018/04/20 - [packages] security/kc storage format change</h3>

The storage format of keychains has changed in a backward incompatible way.
Dump all your keychains to xml before updating:

<blockquote><pre>
$ <b>kc -k ~/.kc/default.kcd</b>
Password:
&lt;example_chain% &gt; <b>dump kcdump</b>
Dump OK
&lt;example_chain% &gt; <b>quit</b>
</pre></blockquote>

After updating follow the instructions in
<tt>/usr/local/share/doc/kc/Changelog</tt>.


<h3 id="r20180503">2018/05/03 - [packages] sysutils/apcupsd has SMTP client removed</h3>

The <tt>${PREFIX}/sbin/smtp</tt> was removed from apcupsd package
in favor of <a href="https://man.openbsd.org/smtp.1">smtp(1)</a>.
The programs are not option-compatible, so any scripts using &quot;smtp&quot;
command require adjustment.


<h3 id="r20180522">2018/05/22 - [packages] PHP default version changed</h3>
<!-- XXX 6.4: merge with r20180527 -->
With a few exceptions, most packages using PHP have switched to
using PHP 7.0 dependencies by default.
Because extension modules (now including PECL modules) are packaged
for multiple PHP versions, most existing PHP programs will work as-is,
but to avoid confusion and benefit from improvements to PHP you should
switch your system across:

<ol>
  <li>Merge local configuration changes from <tt>/etc/php-5.6.ini</tt> to
  <tt>/etc/php-7.0.ini</tt>.
  It may be useful to <a href="https://man.openbsd.org/diff">diff(1)</a>
  against the original file in
  <tt>/usr/local/share/examples/php-5.6/php.ini-production</tt>.

  <li>Create new symlinks for extension modules as described in
  the "extension modules" section of
  <tt>/usr/local/share/doc/pkg-readmes/php-7.0*</tt>.

  <li>Switch to running the new version. If using php-fpm:
  <blockquote><pre>
  # <b>rcctl disable php56_fpm; rcctl enable php70_fpm</b>
  # <b>rcctl stop php56_fpm; rcctl start php70_fpm</b><!--
  --></pre></blockquote>
  If using the module for Apache httpd, update the symlink for
  <tt>/var/www/conf/modules/php.conf</tt> as shown in the pkg-readme.
</ol>


<h3 id="r20180524">2018/05/24 - smtpd.conf(5) grammar has changed in smtpd(8)</h3>

The <a href="https://man.openbsd.org/smtpd.conf.5">smtpd.conf(5)</a> file needs to
be adapted to use the new grammar.

<p>
The change is mostly mechanical and requires splitting current rules into actions
and matching patterns, examples are available in the man page.

<p>
Authenticated users are no longer considered as local users,
if your configuration file allows remote users to authenticate and send mail,
an explicit rule must be written to match these.

<p>
<a href="https://man.openbsd.org/smtpd.8">smtpd(8)</a> supported LMTP both as a
relaying protocol and as a local delivery method.
The local delivery method was implemented within the daemon and not as an MDA,
it no longer does and must be used through the 'mda' action:

<blockquote><pre>
action lmtp-local mda "/usr/libexec/mail.lmtp [...]"
</pre></blockquote>

The <a href="https://man.openbsd.org/mail.lmtp.8">mail.lmtp(8)</a> MDA provides
all the features that used to be supported interally by
<a href="https://man.openbsd.org/smtpd.8">smtpd(8)</a>.


<h3 id="r20180527">2018/05/27 - [packages] PHP packaging changes</h3>

The PHP module for Apache HTTPD has moved from the main PHP package
into a separate "php-apache" package.
If you use this module, install the relevant version (<tt>pkg_add php-apache%7.0</tt>
or <tt>pkg_add php-apache%5.6</tt>).
FPM and CLI remain in the main PHP package.


<h3 id="r20180530">2018/05/30 - smtpd.conf(5) LMTP action introduced</h3>

With the recent grammar change, LMTP support was re-implemented as an external
mail delivery agent and required being configured using the 'mda' action:

<blockquote><pre>
action lmtp-local mda "/usr/libexec/mail.lmtp [...]"
</pre></blockquote>

The grammar has been extended to provide an LMTP action hiding the details
behind the <a href="https://man.openbsd.org/mail.lmtp.8">mail.lmtp(8)</a> MDA.
The LMTP action is documented in <a href="https://man.openbsd.org/smtpd.conf.5">smtpd.conf(5)</a>
and looks as follow:

<blockquote><pre>
action lmtp-local lmtp localhost:25
</pre></blockquote>

In addition, the unix: and inet: prefixes which were used in LMTP destinations
to distinguish between a UNIX socket or a network socket have been removed.


<h3 id="r20180601">2018/06/01 - smtpd.conf(5) 'set' and 'limit' removed as main keywords</h3>

The grammar allowed setting options of components with the 'set' keyword:

<blockquote><pre>
set queue compression
set mta max-deferred 100
</pre></blockquote>

The keyword brought no value and was dropped in favor of component namespaces:

<blockquote><pre>
queue compression
mta max-deferred 100
</pre></blockquote>

In addition, the 'limit' option which could be used with mta:

<blockquote><pre>
limit mta session-transaction-delay 0
</pre></blockquote>

is now an option within the 'mta' namespace:

<blockquote><pre>
mta limit session-transaction-delay 0
</pre></blockquote>

<h3 id="r20180604">2018/06/04 - New sysctl/mixerctl settings to control audio recording</h3>

Due to privacy concerns from some, audio recording has been disabled
by default.
It may be reenabled system-wide like this:

<blockquote><pre>
# <b>sysctl kern.audio.record=1</b> # enable at runtime
# <b>echo kern.audio.record=1 >> /etc/sysctl.conf</b> # set at boot
</pre></blockquote>

Finer-grained controls are available using
<a href="//man.openbsd.org/mixerctl.1">mixerctl(1)</a> which allows
setting record.enable for each mixer device to off (always off), on (always on),
or sysctl (default: follow state of the kern.audio.record sysctl).


<h3 id="r20180613">2018/06/13 - bgpd configuration change</h3>

By default <a href="//man.openbsd.org/bgpd.8">bgpd(8)</a>, without explicit
policy configuration, will deny both incoming and outgoing <tt>UPDATES</tt>.
See <a href="https://tools.ietf.org/html/rfc8212">RFC 8212</a> for more
information.

<p>
The following configuration directives have been deprecated (but will be
accepted for backwards compatibility) <tt>announce all</tt>,
<tt>announce none</tt>, and <tt>announce default-route</tt>.
Furthermore the <tt>announce self</tt> directive has been removed.
Explicit use of <tt>announce self</tt> will result in a syntax error preventing
<a href="//man.openbsd.org/bgpd.8">bgpd(8)</a> from starting.
Users are advised to review and update <tt>/etc/bgpd.conf</tt> before upgrading.

<p>
It is possible to write configuration files that are valid and functionally the
same both before and after the update.

<p>
<b>Before updating:</b>
<ol>
  <li>Mimic the new behavior of the updated
      <a href="//man.openbsd.org/bgpd.8">bgpd(8)</a> by adding
      <tt>deny from any</tt> and <tt>deny to any</tt> to the top of
      the filter ruleset.
      (After the update these rules are implicitly added to the filter)
  <li>Replace all instances of <tt>announce self</tt> with
      <tt>announce all</tt>.
  <li>Ensure that the filter ruleset only allows correct announcements to and
      from EBGP neighbors by explicitly specifying the prefixes to be imported
      from and exported to EBGP neighbors using <tt>prefix-set</tt> and
      <tt>large-community</tt> (or <tt>community</tt>).
  <li>Add <tt>announce all</tt> to all neighbors for which neither
      <tt>announce none</tt> nor <tt>announce default-route</tt> is specified
      (the implicit default for EBGP peers was <tt>announce self</tt>).
      You can confirm that you haven't missed any:
<blockquote><pre>
# <b>bgpd -nvf /etc/bgpd.conf | grep -B4 'announce self'</b>
</pre></blockquote>
</ol>

The resulting config should now be ready for the upgrade.
It is recommended to review <tt>/etc/examples/bgpd.conf</tt> for an example how
BGP communities and <tt>prefix-set</tt> can be used in simple network designs.

<p>
<b>After:</b>
<ol>
  <li>Remove all <tt>announce all</tt> directives from the configuration
  <li>The <tt>deny from all</tt> and <tt>deny to any</tt> rules at the top of
      the ruleset filter are redundant after the update (and as such could be
      removed), but leaving those may improve readability of the configuration.
</ol>


<h3 id="r20180613b">2018/06/13 - httpd.conf(5) 'root strip' option renamed</h3>

To be semantically correct, the 'root strip' option has been renamed
to 'request strip'. For example, the following configuration block is
needed for <a href="https://man.openbsd.org/acme-client.1">acme-client(1)</a>:

<blockquote><pre>
location "/.well-known/acme-challenge/*" {
	root "/acme"
	request strip 2
}
</pre></blockquote>

<h3 id="r20180618">2018/06/18 - slaacd(8) fully pledged</h3>

slaacd(8)'s main process is now pledged and uses the new
&quot;wroute;&quot; promise.
Make sure to have a current kernel or update via snapshots.

<h3 id="r20180623">2018/06/23 - [packages] buildbot/buildslave switch to python3 &amp; buildslave rc script renaming</h3>

Both, buildbot and buildbot-worker are now using python3.

<p>
Upstream renamed <tt>buildslave</tt> to <tt>buildbot-worker</tt> a while ago.
Accordingly, the the <tt>buildslave</tt> rc script was renamed to
<tt>buildbot_worker</tt>.
You need to adjust the list of daemons:

<blockquote><pre>
# <b>rcctl disable buildslave</b>
# <b>rcctl enable buildbot_worker</b>
</pre></blockquote>

Make sure to stop any running <tt>buildslave</tt> instances before upgrading,
otherwise <a href="faq10.html#rc">rc.d(8)</a> will lose track of the process.


<hr id="end">
<small>$OpenBSD: current.html,v 1.921 2018/06/24 00:09:48 tb Exp $</small>

</body>
</html>
