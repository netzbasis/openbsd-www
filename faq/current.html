<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Following -current and using snapshots</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="copyright" content="This document copyright 2005-2017 by OpenBSD">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="../openbsd.css">
<link rel="canonical" href="https://www.openbsd.org/faq/current.html">
</head>

<body bgcolor= "#ffffff" text= "#000000">

<h2>
<a href="../index.html">
<font color="#0000ff"><i>Open</i></font><font color="#000084">BSD</font></a>
<font color="#e00000">Following <i>-current</i> and using snapshots</font>
<small>
<a href="index.html" style="font-weight:normal; float:right">[FAQ Index]</a>
</small>
</h2>
<hr>
<p>

Active OpenBSD development is known as the
<a href="faq5.html#Flavors">-current</a> branch.
These sources are frequently compiled into releases known as <i>snapshots</i>.
Active development sometimes pushes aggressive changes, and complications can
arise when building the latest code from a previous point in time.
Some of the shortcuts for getting over these hurdles are explained on this page.
In general, it's far better to use the
<!-- XXXrelease -->
<a href="upgrade61.html">OpenBSD upgrade procedure</a>
with a newer snapshot, as developers will have gone through the trouble for
you already.

<p>
Make sure you've read and understand how to
<a href="faq5.html">build the system from source</a>
before using -current and the instructions below.

<p>
You should <b>always</b> use a snapshot as the starting point for running
<i>-current</i>.
Upgrading by compiling your own source code is not supported.

<p>
Most of these changes will have to be performed as root.


<h3 id="r20170417">2017/04/17 - build infrastructure change</h3>

The build infrastructure has been changed to allow building <tt>clang</tt>
alongside <tt>gcc</tt>.
This requires an update of the make "include" files:

<blockquote><pre>
# <b>cd /usr/src/share/mk && make install</b>
</pre></blockquote>


<h3 id="r20170419">2017/04/19 - clang enabled for amd64 and i386</h3>

The <tt>clang</tt> compiler is now built alongside <tt>gcc</tt> on the amd64 and
i386 architectures.
It is recommended that you upgrade using a snapshot.

<p>
If you build your own releases, note that <tt>make release</tt> now needs more
than <tt>2G</tt> space on <tt>/usr/obj</tt>.
Increasing the size to <tt>3G</tt> is recommended.

<p>
If you wish to upgrade from source, you need to bootstrap <tt>clang</tt>:

<blockquote><pre>
# <b>pkg_add g++</b>
# <b>cd /usr/src/gnu/usr.bin/clang</b>
# <b>make obj</b>
# <b>make BOOTSTRAP_CLANG=yes</b>
# <b>make install</b>
</pre></blockquote>

Compile <tt>libcompiler_rt</tt>:

<blockquote><pre>
# <b>cd /usr/src/lib/libcompiler_rt</b>
# <b>make obj</b>
# <b>make depend</b>
# <b>make</b>
# <b>make install</b>
</pre></blockquote>

Then do a regular <tt>make build</tt> and <tt>make release</tt>.

<h3 id="r20170427">2017/04/27 - [ports] beats updated</h3>
<tt>filebeat</tt> and <tt>packetbeat</tt> were updated to 5.3.1 which
significantly changed the configuration file layout from 1.x to 5.x. Please refer to
the <a href="https://www.elastic.co/guide/en/beats/libbeat/5.0/upgrading-1-to-5.html">upstream
documentation</a> for migrating your configuration. Also take note of
the <a href="https://www.elastic.co/guide/en/beats/libbeat/5.0/release-notes-5.0.0.html">breaking
changes</a> when upgrading to 5.3.1.
<br>
<tt>topbeat</tt> has been merged into <tt>metricbeat</tt>, a
<a href="https://www.elastic.co/guide/en/beats/libbeat/current/upgrading-1-to-5.html#_upgrading_topbeat_to_metricbeat">
migration path</a> is available.


<h3 id="r20170507">2017/05/07 - amd64: argument printing in ddb stack traces</h3>

On amd64, <a href="https://man.openbsd.org/ddb">ddb(4)</a> now supports printing
of arguments in stack traces.
This relies on the new <tt>-msave-args</tt> compiler option.
If your last upgrade predates Apr 28, you need to build a new
<a href="https://man.openbsd.org/cc">cc(1)</a> before you can build a new kernel:

<blockquote><pre>
# <b>cd /usr/src/gnu/usr.bin/cc</b>
# <b>make obj</b>
# <b>make depend</b>
# <b>make</b>
# <b>make install</b>
</pre></blockquote>


<h3 id="r20170515">2017/05/15 - breaking change for nvme(4) users with GPT</h3>

If you are booting from an <a href="https://man.openbsd.org/nvme">nvme(4)</a>
drive with a GPT disk layout, you are affected by an off-by-one in the driver
with the consequence that the sector count in your partition table may be
incorrect.
The only way to fix this is to re-initialize the partition table.
<a href="faq14.html#DupFS">Backup your data</a> to another disk
before you upgrade.
In the new <tt>bsd.rd</tt>, drop to a shell and re-initialize the GPT:

<blockquote><pre>
# <b>fdisk -iy -g -b 960 sdN</b>
</pre></blockquote>

Then do a fresh install and restore the data from the backup.


<h3 id="r20170529">2017/05/29 - ksh plaintext history file</h3>

The <a href="https://man.openbsd.org/ksh">ksh(1)</a> history file
(used when <tt>$HISTFILE</tt> is set) changed from a binary file format
to plaintext.
If you wish to retain your current ksh history,
create a plaintext version of it before upgrading:

<blockquote><pre>
$ <b>fc -ln 1 | cut -f2- > ~/ksh_hist.txt</b>
</pre></blockquote>

After the upgrade, you can use <tt>ksh_hist.txt</tt> as your history file.
If you mount <tt>HOME</tt> via <tt>NFS</tt>, ensure that machines running
-current use a different <tt>HISTFILE</tt> than machines running 6.1 or earlier.

<p>
If you upgrade from source, note that the old ksh recklessly truncates a
history file that it doesn't understand, so be careful not to run interactive
sessions of the old and new ksh in parallel.
A reboot after the build is recommended.


<h3 id="r20170530">2017/05/30 - IPv6 stateless address auto configuration
moved to userland</h3>

Sending of router solicitations and processing of router advertisements
has been disabled in the kernel.
This task is now handled by
<a href="https://man.openbsd.org/slaacd">slaacd(8)</a>.
If you upgrade by building from source, make sure that kernel and userland
are kept in sync to avoid losing IPv6 stateless address auto configuration.


<h3 id="r20170531">2017/05/31 - pf blocks IPv6 options header</h3>

IPv6 packets that have a hop-by-hop options header or a destination options
header are now blocked by <a href="https://man.openbsd.org/pf.4">pf(4)</a>.
Thus, IPv6 options are handled like their counterparts in IPv4.
Add <tt>allow-opts</tt> to your rule if you want to pass IP packets
with options.


<h3 id="r20170603">2017/06/03 - slaacd(8) moved to /sbin</h3>

There were a few snapshots that had
<a href="https://man.openbsd.org/slaacd">slaacd(8)</a> in <tt>/usr/sbin</tt>.
The old binary can be removed if the new one in <tt>/sbin</tt> is present:

<blockquote><pre>
# <b>rm /usr/sbin/slaacd</b>
</pre></blockquote>


<h3 id="r20170622">2017/06/22 - KARL: link-kit transition</h3>

If you upgrade from source, you need to compile and install a new
<a href="https://man.openbsd.org/config">config(8)</a> binary before
building a new kernel:

<blockquote><pre>
# <b>cd /usr/src/usr.sbin/config</b>
# <b>make obj</b>
# <b>make &amp;&amp; make install</b>
</pre></blockquote>

In any kernel directory, you must issue <tt><b>make config</b></tt>:

<blockquote><pre>
# <b>cd /sys/arch/$(machine)/compile/GENERIC.MP</b>
# <b>make obj</b>
# <b>make config</b>
# <b>make &amp;&amp; make install</b>
</pre></blockquote>

The <b><tt>make install</tt></b> step will also enable the kernel relinking on
each boot.
Therefore, installing kernels with <b><tt>make install</tt></b> is recommended.
Developers can deactivate the kernel relinking at reboot time by installing
kernels with <tt><b>cp obj/bsd /bsd</b></tt> and reactivate the automatic
process using <tt><b>make install</b></tt>.

<h3 id="r20170629">2017/06/29 - vlan(4)/svlan(4) ifconfig(8) changes</h3>

The
<a href="https://man.openbsd.org/vlan.4">vlan(4)</a> and
<a href="https://man.openbsd.org/vlan.4">svlan(4)</a>
specific configuration options in
<a href="https://man.openbsd.org/ifconfig.8">ifconfig(8)</a>
and
<a href="https://man.openbsd.org/hostname.if.5">hostname.if(5)</a>
have been deprecated in favour of the generic parent and
vnetid handling.

<p>
The <tt>vlan</tt>, <tt>vlandev</tt>, and <tt>-vlandev</tt> options
are now deprecated in favour of <tt>vnetid</tt>, <tt>-vnetid</tt>,
<tt>parent</tt>, and <tt>-parent</tt> when using ifconfig(8) or
in hostname.if(8) configuration files.
Use of the <tt>vlan</tt> option must be replaced with <tt>vnetid</tt>.
Because VLAN tag 0 is invalid according to the relevant VLAN
specifications, the <tt>vnetid</tt> option does not accept 0 as a
valid network identifier.
To use VLAN tag 0 on the wire the vnetid can be unconfigured with
<tt>-vnetid</tt>.
Use of <tt>vlandev</tt> and <tt>-vlandev</tt> must be replaced with
<tt>parent</tt> and <tt>-parent</tt> respectively.

<p>
Unlike <tt>vlan</tt> and <tt>vlandev</tt>, <tt>vnetid</tt> and
<tt>parent</tt> do not implicitly bring the vlan interface up.
Similarly, the <tt>vlan</tt> option is no longer implied by the
interface's minor when it is not explicitly set.

<p>
<a href="https://man.openbsd.org/ifconfig.8">ifconfig(8)</a>
no longer outputs a vlan specific status line, or separate vnetid
and parent lines.
The vnetid and parent lines have been merged into a single encap
line containing the VLAN tag and parent information.

<p>An example of the changes to a vlan(4) configuration file and
the ifconfig(8) output is below. Before the changes:

<blockquote><pre>
# <b>cat /etc/hostname.vlan7</b>
vlandev em0 <em># vlan 7 and up are implied</em>
lladdr random
# <b>ifconfig vlan7</b>
vlan7: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500
        lladdr 70:a7:3a:75:da:2d
	index 7 priority 0 llprio 3
	vlan: 7 parent interface: em0
	vnetid: 7
	parent: em0
	status: active
</pre></blockquote>

After the changes:

<blockquote><pre>
# <b>cat /etc/hostname.vlan7</b>
vnetid 7 parent em0
up
lladdr random
# <b>ifconfig vlan7</b>
vlan7: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500
        lladdr 60:e8:d7:0d:10:6d
        index 7 priority 0 llprio 3
        encap: vnetid 7 parent: em0
        groups: vlan
        status: active
</pre></blockquote>


<h3 id="r20170711">2017/07/11 - "listen secure" syntax removed from smtpd.conf</h3>

The <tt>secure</tt> keyword is not valid anymore in <tt>listen</tt> directives
in <a href="https://man.openbsd.org/smtpd.conf">smtpd.conf(5)</a>.
Users are advised to replace existing <tt>listen secure</tt> directives with
two separate <tt>tls</tt> and <tt>smtps</tt> listeners, i.e., a line like

<blockquote><pre>
listen on $iface secure pki $pki
</pre></blockquote>

has to be replaced with

<blockquote><pre>
listen on $iface tls pki $pki
listen on $iface smtps pki $pki
</pre></blockquote>

Relaying syntax is not affected by this change.


<h3 id="r20170718">2017/07/18 - KARL: new config(8) needed</h3>

If you upgrade from source, changes in the kernel makefiles require you to
compile and install a new <a href="https://man.openbsd.org/config">config(8)</a>
binary before building a new kernel:

<blockquote><pre>
# <b>cd /usr/src/usr.sbin/config</b>
# <b>make obj</b>
# <b>make &amp;&amp; make install</b>
</pre></blockquote>

In addition, you must issue <tt><b>make config</b></tt>:

<blockquote><pre>
# <b>cd /sys/arch/$(machine)/compile/GENERIC.MP</b>
# <b>make obj</b>
# <b>make config</b>
# <b>make &amp;&amp; make install</b>
</pre></blockquote>

before installing and rebooting into the new kernel, otherwise the kernel relink
by <a href="https://man.openbsd.org/rc.8">rc(8)</a> will fail.


<h3 id="r20170720">2017/07/20 - install.site and upgrade.site run later</h3>

The execution of the <tt>{install,upgrade}.site</tt> scripts in <tt>bsd.rd</tt>
was postponed to the end of the installer script.
If you use this functionality, make sure your script still works as expected.
The script will now run after these steps:

<ul>
  <li>make underlying device nodes for softraid devices
  <li>install the boot-block on disk
  <li>switch to MP kernel on multi-processor systems
  <li>update kernel.SHA256 and relink kernel
  <li>prepare execution of
      <a href="https://man.openbsd.org/sysmerge">sysmerge(8)</a> and
      <a href="https://man.openbsd.org/fw_update">fw_update(8)</a> on reboot.
  <li>prepare mail with response file to root/admin user
</ul>


<h3 id="r20170725">2017/07/25 - hostname.if(5) changes</h3>

The keyword <tt>rtsol</tt> is no longer supported in
<a href="https://man.openbsd.org/hostname.if">hostname.if(5)</a>.
Replace it with <tt>inet6 autoconf</tt>.


<h3 id="r20170726">2017/07/26 - Add <tt>-Oz</tt> support to gcc</h3>

To save space on floppies built with clang, some Makefiles switched to using
<tt>-Oz</tt> instead of <tt>-Os</tt>.
If your last upgrade predates Jul 25, you need to build a new gcc that supports
<tt>-Oz</tt> before doing <tt>make build</tt>:

<blockquote><pre>
# <b>cd /usr/src/gnu/usr.bin/cc</b>
# <b>make obj</b>
# <b>make</b>
# <b>make install</b>
</pre></blockquote>


<h3 id="r20170726a">2017/07/26 - amd64 and i386: switch to clang</h3>

The default compiler on the amd64 and i386 architectures is now clang.
To update from source, the following steps are needed:

<blockquote><pre>
# <b>cd /usr/src/share/mk && make install</b>
# <b>ln -f /usr/bin/clang /usr/bin/cc</b>
# <b>ln -f /usr/bin/clang++ /usr/bin/c++</b>
</pre></blockquote>

Then build kernel and userland as usual.


<h3 id="r20170729">2017/07/29 - amd64 and i386: update all packages</h3>

Ensure that all packages are updated to the new clang-compiled versions
by forcing <a href="https://man.openbsd.org/pkg_add">pkg_add(1)</a> to
reinstall them all:

<blockquote><pre>
pkg_add -D installed -u
</pre></blockquote>


<h3 id="r20170803">2017/08/03 - pf.conf: icmp6-type notnbr-unr removed</h3>

Nearly 20 years ago RFC 1885 was obsoleted.
Catch up by no longer supporting notnbr-unr
(<tt>ICMP6_DST_UNREACH_NOTNEIGHBOR</tt>).
The correct type is beyond-unr (<tt>ICMP6_DST_UNREACH_BEYONDSCOPE</tt>).

<p>
In <a href="https://man.openbsd.org/pf.conf">pf.conf(5)</a>,
<tt>notnbr-unr</tt> needs to be replaced with <tt>beyond-unr</tt>.


<h3 id="r20170809">2017/08/09 - [ports] borgmatic updated</h3>

The configuration file changed from INI (<tt>/etc/borgmatic/config</tt>)
to YAML (<tt>/etc/borgmatic/config.yaml</tt>) formatting. Please
upgrade your existing config after updating your package:

<blockquote><pre>
upgrade-borgmatic-config
</pre></blockquote>


<h3 id="r20170812">2017/08/12 - kernel build change</h3>

The kernel build infrastructure now depends on
<a href="https://man.openbsd.org/ctfstrip">ctfstrip(1)</a>.
The executable must be installed before building a kernel:

<blockquote><pre>
# <b>cd /usr/src/usr.bin/ctfconv</b>
# <b>make obj</b>
# <b>make</b>
# <b>make install</b>
</pre></blockquote>

<hr>
<small>$OpenBSD: current.html,v 1.848 2017/08/16 14:37:22 tb Exp $</small>

</body>
</html>
