<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Example: Firewall for Home or Small Office</title>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="carp.html">Previous: Firewall Redundancy with CARP and pfsync</a>]
[<a href="index.html">Contents</a>]

<p>
<h1><font color="#e00000">PF: Example: Firewall for Home or Small Office</font></h1>
<hr>

<h3>Table of Contents</h3>
<ul>
<li><a href="#scenario">The Scenario</a>
	<ul>
	<li><a href="#network">The Network</a>
	<li><a href="#objective">The Objective</a>
	<li><a href="#prep">Preparation</a>
	</ul>
<li><a href="#ruleset">The Ruleset</a>
	<ul>
	<li><a href="#macros">Macros</a>
	<li><a href="#options">Options</a>
	<li><a href="#rules">Firewall Rules</a>
	</ul>
<li><a href="#allrules">The Complete Ruleset</a>
</ul>

<hr>

<h2 id="scenario">The Scenario</h2>
In this example, PF is running on an OpenBSD machine acting as a
firewall and NAT gateway for a small network in a home or office. The
overall objective is to provide Internet access to the network and to
allow limited access to the firewall machine from the Internet, and 
expose an internal web server to the external Internet.  This document
will go through a complete ruleset that does just that.

<h3 id="network">The Network</h3>
The network is setup like this:

<pre>
    
  [ COMP1 ]    [ COMP3 ]
      |            |                               
   ---+------+-----+------- xl0 [ OpenBSD ] fxp0 -------- ( Internet )
             |
         [ COMP2 ]

</pre>

<p>
There are a number of computers on the internal network; the diagram
shows three but the actual number is irrelevant.  These computers are
regular workstations used for web surfing, email, chatting, etc., except
for COMP3 which is also running a small web server.
The internal network is using the 192.168.0.0 / 255.255.255.0 network block.

<p>
The OpenBSD firewall is a Celeron 300 with two network cards: a 3com
3c905B (<tt>xl0</tt>) and an Intel EtherExpress Pro/100 (<tt>fxp0</tt>).
The firewall has
a cable connection to the Internet and is using NAT to share this
connection with the internal network. The IP address on the external
interface is dynamically assigned by the Internet Service Provider.

<h3 id="objective">The Objective</h3>
The objectives are:
<ul>
<li>Provide unrestricted Internet access to each internal computer.
<li>Use a "default deny" filter ruleset.
<li>Allow the following incoming traffic to the firewall from the
Internet:
	<ul>
	<li>SSH (TCP port 22): this will be used for external maintenance of
	the firewall machine.
	<li>Auth/Ident (TCP port 113): used by some services such as SMTP
	and IRC.
	<li>ICMP Echo Requests: the ICMP packet type used by
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8"
>ping(8)</a>.
	</ul>
<li>Redirect TCP port 80 connection attempts (which are attempts to
access a web server) to computer COMP3.
Also, permit TCP port 80 traffic destined for COMP3 through the
firewall.
<li>Log filter statistics on the external interface.
<li>By default, reply with a TCP RST or ICMP Unreachable for blocked
packets.
<li>Make the ruleset as simple and easy to maintain as possible.
</ul>

<h3 id="prep">Preparation</h3>
This document assumes that the OpenBSD host has been properly configured
to act as a router, including verifying IP networking setup, Internet
connectivity, and setting the 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=3"
>sysctl(3)</a> variables <tt>net.inet.ip.forwarding</tt> and/or 
<tt>net.inet6.ip6.forwarding</tt> to "<tt>1</tt>".
You must also have enabled PF using 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+5.6"
>pfctl(8)</a> or by setting the appropriate variable in
<tt>/etc/rc.conf.local</tt>.
PF is enabled by default on OpenBSD 4.6 and newer releases.

<h2 id="ruleset">The Ruleset</h2>
The following will step through a ruleset that will accomplish the above
goals.

<h3 id="macros">Macros</h3>
The following macros are defined to make maintenance and reading of
the ruleset easier:
<blockquote><pre>
int_if="xl0"

tcp_services="{ 22, 113 }"
icmp_types="echoreq"

comp3="192.168.0.3"
</pre></blockquote>

<p>
The first line defines the internal network interface that filtering
will happen on.
By defining it here, if we have to move this system to another 
machine with different hardware, we can change only this line, and 
the rest of the rule set will be still usable.
(For this example, the external interface will be handled by using the
<tt>egress</tt> interface group.
This is automatically set on any interface holding a default route,
in this case, fxp0).
The second and third lines list the TCP port numbers of the services
that will be opened up to the Internet (SSH and ident/auth) and the ICMP
packet types that will be accepted at the firewall machine. 
Finally, the last line defines the IP address of COMP3.

<p>
<b>Note</b>: If the Internet connection required
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=4"
>PPPoE</a>, then filtering and NAT would have to take place on the
<tt>pppoe0</tt> interface and <i>not</i> on the egress interface (<tt>fxp0</tt>).

<h3 id="options">Options</h3>
The following two options will set the default response for
<tt>block</tt> filter rules and turn statistics logging "on" for the
external interface:
<blockquote><pre>
set block-policy return
set loginterface egress
</pre></blockquote>

<p>
Every Unix system has a "loopback" interface.
It's a virtual network interface that is used by applications to talk to
each other inside the system.
On OpenBSD, the loopback interface is 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&amp;sektion=4"
>lo(4)</a>.
It is considered best practice to disable all filtering on loopback
interfaces.
Using <a href="options.html#skip">set skip</a> will accomplish this.
<blockquote><pre>
set skip on lo
</pre></blockquote>
<!-- XXX this should be interface groups, but PF (at least up to
4.8) just does a substring match on the interface name -->
Note that we are skipping for all <tt>lo</tt> interfaces, this
way, should we later add additional loopback interfaces, we won't have
to worry about altering this portion of our existing rules file.

<h3 id="rules">Firewall Rules</h3>

We will start with rules to support the use of
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+5.6"
>ftp-proxy(8)</a> so that FTP clients on the local network can
connect to FTP servers on the Internet.
This works by dynamically inserting rules when an ftp connection
is made.
This is done using an <a href="anchors.html">anchor</a>:
<blockquote><pre>
anchor "ftp-proxy/*"
</pre></blockquote>

<p>
Now we will add the rule needed to divert FTP connections so
they are seen by ftp-proxy(8):
<blockquote><pre>
pass in quick on $int_if inet proto tcp to any port ftp \
    divert-to 127.0.0.1 port 8021
</pre></blockquote>

<p>
This rule will intercept FTP connections to port 21 and divert them
to an ftp-proxy(8) instance running on port 8021 and, through the use
of the <tt>quick</tt> keyword, matching packets will not be further
checked against the rest of the ruleset.
If users regularly connect to FTP servers on other ports, then a
list should be used to specify the destination port, for example:
<tt>to any port { 21, 2121 }</tt>.

<p>
Note that both the <a href="anchors.html">anchor</a> and the
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+5.6"
>ftp-proxy(8)</a> divert rule need to be located before any
<tt>match</tt> rules for NAT or the ftp-proxy(8) will not work
as expected.

<p>
Now we move on to some <tt>match</tt> rules.
By itself, a <tt>match</tt> rule doesn't determine whether or
not a packet is allowed to pass.
Instead, packets matching this rule will have the parameters
remembered; they will then be used in any <tt>pass</tt> rules
which handle these packets.

<p>
This is powerful: parameters such as <a href="nat.html">NAT</a>
or queueing can be applied to certain
classes of packet, and then access permissions can be defined
separately.

<p>
To perform NAT for the entire internal network the following
<tt>match</tt> rule is used:
<blockquote><pre>
match out on egress inet from !(egress:network) to any nat-to (egress:0)
</pre></blockquote>

<p>
In this case, the "<tt>!(egress:network)</tt>" could easily be
replaced by a "<tt>$int_if:network</tt>", but if you added multiple
internal interfaces, you would have to add additional NAT rules,
whereas with this structure, NAT will be handled on all protected
interfaces.

<p>
Since the IP address on the external interface is assigned dynamically,
parenthesis are placed around the translation interface so that PF
will notice when the address changes.
The :0 suffix is used so that, if the external interface has multiple
addresses, only the first address is used for translation.

<p>
Lastly, the protocol family <tt>inet</tt> (IPv4) is specified.
This avoids translating any <tt>inet6</tt> (IPv6) packets which may
be received.

<p>
Now the rules to control access permissions.
Start with the default deny:
<blockquote><pre>
block in log
</pre></blockquote>

<p>
At this point all traffic attempting to come into an interface will
be blocked, even that from the internal network.
These packets will also be logged.
Later rules will open up the firewall as per
the objectives above as well as open up any necessary virtual
interfaces.

<p>
Keep in mind, pf can block traffic coming into or leaving out of an
interface.
It can simplify your life if you choose to filter traffic in one
direction, rather than trying to keep it straight when filtering some
things in, and some things out.
In our case, we'll opt to filter the inbound traffic, but once the
traffic is permitted into an interface, we won't try to obstruct it
leaving, so we will do the following:

<blockquote><pre>
pass out quick
</pre></blockquote>

By using <tt>quick</tt>, outbound packets can avoid being checked
against the following rules, improving performance.

<p>
It is good to use the <a href="filter.html#antispoof">spoofed address
protection</a>:
<blockquote><pre>
antispoof quick for { lo $int_if }
</pre></blockquote>

<p>
Now open the ports used by those network services that will be available
to the Internet.
First, the traffic that is destined to the firewall itself:

<blockquote><pre>
pass in on egress inet proto tcp from any to (egress) \
    port $tcp_services
</pre></blockquote>

<p>
Specifying the network ports in the macro <tt>$tcp_services</tt> makes
it simple to open additional services to the Internet by simply editing
the macro and reloading the ruleset. UDP services can also be opened up
by creating a <tt>$udp_services</tt> macro and adding a filter rule,
similar to the one above, that specifies <tt>proto udp</tt>.

<p>
The next rule catches any attempts by someone on the Internet to
connect to TCP port 80 on the firewall. 
Legitimate attempts to access this port will be from users trying to
access the network's web server.
These connection attempts need to be redirected to COMP3:

<blockquote><pre>
pass in on egress inet proto tcp to (egress) port 80 rdr-to $comp3
</pre></blockquote>

<p>
ICMP traffic needs to be passed:
<blockquote><pre>
pass in inet proto icmp all icmp-type $icmp_types
</pre></blockquote>

<p>
Similar to the <tt>$tcp_services</tt> macro, the <tt>$icmp_types</tt>
macro can easily be edited to change the types of ICMP packets that will
be allowed to reach the firewall. Note that this rule applies to all
network interfaces.

<p>
Now traffic must be passed to and from the internal network.
We'll assume that the users on the internal network know what
they are doing and aren't going to be causing trouble.  This is not
necessarily a valid assumption; a much more restrictive ruleset would
be appropriate for many environments.
<blockquote><pre>
pass in on $int_if
</pre></blockquote>

<p>
TCP, UDP, and ICMP traffic is permitted to exit the firewall towards the
Internet due to the earlier "<tt>pass out</tt>" line.
State information is kept so that the returning packets will be passed
back in through the firewall.

<h2 id="allrules">The Complete Ruleset</h2>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# macros

int_if="xl0"

tcp_services="{ 22, 113 }"
icmp_types="echoreq"

comp3="192.168.0.3"

# options

set block-policy return
set loginterface egress
set skip on lo

# FTP Proxy rules

anchor "ftp-proxy/*"

pass in quick on $int_if inet proto tcp to any port ftp \
    divert-to 127.0.0.1 port 8021

# match rules

match out on egress inet from !(egress:network) to any nat-to (egress:0)

# filter rules

block in log
pass out quick

antispoof quick for { lo $int_if }

pass in on egress inet proto tcp from any to (egress) \
    port $tcp_services

pass in on egress inet proto tcp to (egress) port 80 rdr-to $comp3

pass in inet proto icmp all icmp-type $icmp_types

pass in on $int_if
</pre>
</td></tr>
</table>

<p>
[<a href="carp.html">Previous: Firewall Redundancy with CARP and pfsync</a>]
[<a href="index.html">Contents</a>]

<p>
</body>
</html> 
